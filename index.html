<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FalakZoom</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: black;
        font-family: "Poppins", "Cairo", Arial, sans-serif; /* Added Cairo */
      }

      /* Updated infoPanel position */
      #infoPanel {
        position: absolute;
        top: 70px;
        left: 20px;
        background: rgba(0, 0, 0, 0.85); /* Slightly more opaque */
        color: white;
        padding: 20px; /* Increased padding */
        border-radius: 10px; /* Smoother radius */
        border: 1px solid rgba(255, 255, 255, 0.4); /* Subtler border */
        display: none;
        max-width: 380px; /* Slightly wider */
        font-size: 14px;
        line-height: 1.7; /* Increased line height */
        z-index: 50;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4); /* Added shadow */
      }

      /* Updated styles for better readability */
      #infoPanel h2 {
          margin-top: 0;
          margin-bottom: 15px;
          font-size: 18px;
          font-weight: 600;
          border-bottom: 1px solid rgba(255, 255, 255, 0.3);
          padding-bottom: 8px;
      }

      #infoPanel p {
          margin-bottom: 10px;
      }

       #infoPanel .fact {
           font-style: italic;
           color: #cccccc; /* Lighter color for facts */
           margin-top: 15px;
           padding-top: 10px;
           border-top: 1px dashed rgba(255, 255, 255, 0.2);
       }


      #closeBtn {
        position: absolute;
        top: 10px;
        left: 10px; /* Changed to left for LTR consistency */
        width: 28px; /* Adjusted size */
        height: 28px; /* Adjusted size */
        font-size: 16px;
        font-weight: bold;
        color: #ff6b6b; /* Softer red */
        cursor: pointer;
        transition: transform 0.3s ease, color 0.3s ease,
          background 0.3s ease;
        padding: 0;
        background: rgba(255, 255, 255, 0.1); /* Slight background */
        border: none;
        border-radius: 50%; /* Circular */
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #closeBtn:hover {
        color: #ff4757;
        transform: scale(1.1) rotate(90deg); /* Added rotation */
        background: rgba(255, 255, 255, 0.2);
      }

      /* Menu Bar Styles */
      #menuBar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 50px;
        background: rgba(0, 0, 0, 0.8); /* Slightly more opaque */
        padding: 0 20px; /* Adjusted padding */
        box-sizing: border-box;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .menu-controls {
          display: flex; /* Group menu items */
          align-items: center;
      }

      .menu-item, #langToggleBtn /* Apply same style to lang button */ {
        position: relative;
        color: white;
        padding: 8px 15px;
        margin-left: 10px; /* Spacing between items */
        cursor: pointer;
        font-family: "Poppins", "Cairo", sans-serif;
        border-radius: 4px;
        transition: background 0.3s ease, color 0.3s ease;
        font-size: 14px;
        user-select: none; /* Prevent text selection */
      }

      .menu-item:hover, #langToggleBtn:hover {
        background: rgba(255, 255, 255, 0.2);
        color: #eee;
      }

      .dropdown {
        position: absolute;
        top: 100%;
        right: 0; /* Align dropdown to the right */
        background: rgba(25, 25, 25, 0.95); /* Darker dropdown */
        min-width: 180px; /* Adjusted width */
        border-radius: 0 0 6px 6px; /* Rounded bottom corners */
        overflow: hidden;
        display: none;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6); /* Stronger shadow */
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-top: none;
        z-index: 110; /* Ensure dropdown is above info panel */
      }

      .dropdown.show {
        display: block;
      }

      .dropdown-item {
        padding: 12px 20px; /* Increased padding */
        color: #e0e0e0; /* Lighter text */
        text-decoration: none;
        display: block;
        transition: background 0.2s ease, color 0.2s ease;
        font-size: 14px;
        white-space: nowrap; /* Prevent wrapping */
      }

      .dropdown-item:hover {
        background: rgba(255, 255, 255, 0.15);
        color: white;
      }

      #title {
        color: white;
        font-family: "Poppins", sans-serif;
        font-size: 22px; /* Slightly smaller */
        font-weight: 600;
      }

       /* Adjust infoPanel position based on language */
       body[dir="rtl"] #infoPanel {
            left: auto;
            right: 20px;
            text-align: right;
       }
       body[dir="ltr"] #infoPanel {
            left: 20px;
            right: auto;
            text-align: left;
       }
        /* Adjust close button position based on language */
       body[dir="rtl"] #closeBtn {
            left: 10px;
            right: auto;
       }
       body[dir="ltr"] #closeBtn {
            left: auto;
            right: 10px; /* Position right for LTR */
       }

    </style>
  </head>
  <body dir="rtl"> <div id="menuBar">
      <div id="title">FalakZoom</div>
      <div class="menu-controls"> <div id="langToggleBtn">English</div> <div class="menu-item" id="planetsMenu">
          الكواكب
          <div class="dropdown" id="planetsDropdown">
            </div>
        </div>
      </div>
    </div>

    <div id="infoPanel">
      <span id="closeBtn">X</span>
      <h2 id="planetName"></h2>
      <p id="planetInfo"></p>
      <p id="planetFact" class="fact"></p> </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/controls/OrbitControls.js"></script>
    <script>
      // --- Language and UI Text ---
      let currentLanguage = 'ar'; // Default language ('ar' or 'en')

      const uiText = {
          planetsMenu: { ar: "الكواكب", en: "Planets" },
          langToggle: { ar: "English", en: "العربية" },
          // Add other UI elements if needed
      };

      // --- Planet Data with Multilingual Support ---
      const planetsData = [
        {
          id: 0, // Added ID for easier lookup
          name: { ar: "الشمس", en: "Sun" },
          radius: 5, distance: 0, speed: 0, tilt: 0, rotation: 0.01,
          texture: "sun.jpg",
          info: {
            ar: "القطر: 1.391 مليون كيلومتر\nالكتلة: 1.989 × 10³⁰ كيلوغرام\nالعمر: 4.6 مليار سنة\nالنوع: نجم من النوع G\nدرجة حرارة النواة: 15 مليون درجة مئوية",
            en: "Diameter: 1.391 million km\nMass: 1.989 × 10³⁰ kg\nAge: 4.6 billion years\nType: G-type main-sequence star\nCore Temperature: 15 million °C",
          },
          fact: {
            ar: "الشمس تحتوي على 99.86% من كتلة النظام الشمسي وهي مصدر الطاقة الرئيسي للحياة على الأرض.",
            en: "The Sun contains 99.86% of the Solar System's mass and is the primary source of energy for life on Earth.",
          }
        },
        {
          id: 1,
          name: { ar: "عطارد", en: "Mercury" },
          radius: 0.5, distance: 10, speed: 0.0125, tilt: 0.034, rotation: 0.003,
          texture: "mercury.jpg",
          info: {
            ar: "القطر: 4,879 كيلومتر\nالكتلة: 3.3 × 10²³ كيلوغرام\nالمدار: 88 يومًا\nدرجة حرارة السطح: من -173°م إلى 427°م\nلا يوجد غلاف جوي تقريبًا",
            en: "Diameter: 4,879 km\nMass: 3.3 × 10²³ kg\nOrbit: 88 days\nSurface Temp: -173°C to 427°C\nAlmost no atmosphere",
          },
          fact: {
             ar: "يوم واحد على عطارد (دورة شمسية) يستغرق حوالي 176 يومًا أرضيًا بسبب دورانه البطيء ومداره السريع.",
             en: "One solar day on Mercury lasts about 176 Earth days due to its slow rotation and fast orbit."
          }
        },
        {
          id: 2,
          name: { ar: "الزهرة", en: "Venus" },
          radius: 0.8, distance: 15, speed: 0.004375, tilt: 177.4, rotation: 0.0004,
          texture: "venus.jpg",
          info: {
            ar: "القطر: 12,104 كيلومتر\nالكتلة: 4.87 × 10²⁴ كيلوغرام\nالمدار: 225 يومًا\nدرجة حرارة السطح: 464°م\nغلاف جوي كثيف من ثاني أكسيد الكربون",
            en: "Diameter: 12,104 km\nMass: 4.87 × 10²⁴ kg\nOrbit: 225 days\nSurface Temp: 464°C\nThick CO2 atmosphere",
          },
          fact: {
              ar: "الزهرة هي أسخن كواكب المجموعة الشمسية وتدور بعكس اتجاه دوران معظم الكواكب الأخرى (حركة تراجعية).",
              en: "Venus is the hottest planet and rotates backwards compared to most other planets (retrograde rotation)."
          }
        },
        {
          id: 3,
          name: { ar: "الأرض", en: "Earth" },
          radius: 1, distance: 20, speed: 0.003125, tilt: 23.5, rotation: 0.05,
          texture: "earth.jpg",
          info: {
            ar: "القطر: 12,742 كيلومتر\nالكتلة: 5.97 × 10²⁴ كيلوغرام\nالمدار: 365.25 يومًا\nدرجة حرارة السطح: من -88°م إلى 58°م\nمغطاة بنسبة 71% بالمياه",
            en: "Diameter: 12,742 km\nMass: 5.97 × 10²⁴ kg\nOrbit: 365.25 days\nSurface Temp: -88°C to 58°C\n71% covered by water",
          },
           fact: {
               ar: "الأرض هي الكوكب الوحيد المعروف حاليًا بوجود حياة ومياه سائلة على سطحه.",
               en: "Earth is the only known planet to host life and have liquid water on its surface."
           }
        },
        {
          id: 4,
          name: { ar: "المريخ", en: "Mars" },
          radius: 0.7, distance: 25, speed: 0.0025, tilt: 25.2, rotation: 0.048,
          texture: "mars.jpg",
          info: {
            ar: "القطر: 6,792 كيلومتر\nالكتلة: 6.42 × 10²³ كيلوغرام\nالمدار: 687 يومًا\nدرجة حرارة السطح: من -153°م إلى 20°م\nغلاف جوي رقيق من ثاني أكسيد الكربون",
            en: "Diameter: 6,792 km\nMass: 6.42 × 10²³ kg\nOrbit: 687 days\nSurface Temp: -153°C to 20°C\nThin CO2 atmosphere",
          },
          fact: {
              ar: "يُعرف المريخ بالكوكب الأحمر بسبب أكسيد الحديد (الصدأ) على سطحه، ولديه أعلى بركان وأكبر وادي في النظام الشمسي.",
              en: "Mars is known as the Red Planet due to iron oxide (rust) on its surface and has the tallest volcano and largest canyon in the Solar System."
          }
        },
        {
          id: 5,
          name: { ar: "المشتري", en: "Jupiter" },
          radius: 2.5, distance: 35, speed: 0.00125, tilt: 3.1, rotation: 0.1,
          texture: "jupiter.jpg",
          info: {
            ar: "القطر: 139,820 كيلومتر\nالكتلة: 1.898 × 10²⁷ كيلوغرام\nالمدار: 11.86 سنة\nدرجة حرارة السطح (قمم السحب): -145°م\nعملاق غازي",
            en: "Diameter: 139,820 km\nMass: 1.898 × 10²⁷ kg\nOrbit: 11.86 years\nCloud Top Temp: -145°C\nGas giant",
          },
          fact: {
              ar: "المشتري هو أكبر كواكب المجموعة الشمسية وبه البقعة الحمراء العظيمة، وهي عاصفة ضخمة مستمرة منذ قرون.",
              en: "Jupiter is the largest planet and features the Great Red Spot, a giant storm raging for centuries."
          }
        },
        {
          id: 6,
          name: { ar: "زحل", en: "Saturn" },
          radius: 2, distance: 45, speed: 0.0009375, tilt: 26.7, rotation: 0.09,
          texture: "saturn.jpg",
          info: {
            ar: "القطر: 116,460 كيلومتر\nالكتلة: 5.68 × 10²⁶ كيلوغرام\nالمدار: 29.46 سنة\nدرجة حرارة السطح (قمم السحب): -184°م\nعملاق غازي",
            en: "Diameter: 116,460 km\nMass: 5.68 × 10²⁶ kg\nOrbit: 29.46 years\nCloud Top Temp: -184°C\nGas giant",
          },
          fact: {
              ar: "يشتهر زحل بنظام حلقاته المذهل المكون أساسًا من جسيمات الجليد والصخور.",
              en: "Saturn is famous for its stunning ring system, made mostly of ice particles and rock debris."
          }
        },
        {
          id: 7,
          name: { ar: "أورانوس", en: "Uranus" },
          radius: 1.5, distance: 55, speed: 0.0005, tilt: 97.8, rotation: 0.06,
          texture: "uranus.jpg",
          info: {
            ar: "القطر: 50,724 كيلومتر\nالكتلة: 8.68 × 10²⁵ كيلوغرام\nالمدار: 84 سنة\nدرجة حرارة السطح (قمم السحب): -224°م\nعملاق جليدي",
            en: "Diameter: 50,724 km\nMass: 8.68 × 10²⁵ kg\nOrbit: 84 years\nCloud Top Temp: -224°C\nIce giant",
          },
          fact: {
              ar: "يدور أورانوس على جانبه بميل محوري يقارب 98 درجة، مما يجعله فريدًا بين الكواكب.",
              en: "Uranus rotates on its side with an axial tilt of nearly 98 degrees, making it unique among planets."
          }
        },
        {
          id: 8,
          name: { ar: "نبتون", en: "Neptune" },
          radius: 1.5, distance: 65, speed: 0.000375, tilt: 28.3, rotation: 0.07,
          texture: "neptune.jpg",
          info: {
            ar: "القطر: 49,244 كيلومتر\nالكتلة: 1.02 × 10²⁶ كيلوغرام\nالمدار: 164.8 سنة\nدرجة حرارة السطح (قمم السحب): -201°م\nعملاق جليدي",
            en: "Diameter: 49,244 km\nMass: 1.02 × 10²⁶ kg\nOrbit: 164.8 years\nCloud Top Temp: -201°C\nIce giant",
          },
          fact: {
              ar: "نبتون هو أبعد كوكب عن الشمس ويتميز بلونه الأزرق العميق ورياحه الأسرع في النظام الشمسي.",
              en: "Neptune is the farthest planet from the Sun, known for its deep blue color and the fastest winds in the Solar System."
          }
        },
      ];

      // --- THREE.js Setup (Mostly unchanged) ---
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        2000
      );
      camera.position.set(0, 50, 100);
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.maxDistance = 400; // Increased max distance slightly
      controls.minDistance = 10;  // Set a min distance
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      let focusedPlanetIndex = -1;
      let isFollowingPlanet = false;
      let followAnimationId = null; // To cancel camera animation if needed

      controls.addEventListener("start", () => {
        isFollowingPlanet = false;
        focusedPlanetIndex = -1;
        if (followAnimationId) cancelAnimationFrame(followAnimationId); // Stop camera animation
      });

      // Advanced Lighting
      const sunLight = new THREE.PointLight(0xffffff, 1.5, 1500); // Increased range
      sunLight.position.set(0, 0, 0);
      scene.add(sunLight);
      const ambientLight = new THREE.AmbientLight(0x404040, 0.6); // Slightly brighter ambient
      scene.add(ambientLight);
      const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.3);
      hemiLight.position.set(0, 100, 0);
      scene.add(hemiLight);

      // Texture Loader
      const loader = new THREE.TextureLoader();

      // Starry Background
      const starGeometry = new THREE.BufferGeometry();
      const starCount = 7000; // More stars
      const positions = new Float32Array(starCount * 3);
      for (let i = 0; i < starCount; i++) {
        positions[i * 3] = (Math.random() - 0.5) * 2500; // Wider range
        positions[i * 3 + 1] = (Math.random() - 0.5) * 2500;
        positions[i * 3 + 2] = (Math.random() - 0.5) * 2500;
      }
      starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.15 }); // Slightly larger stars
      const stars = new THREE.Points(starGeometry, starMaterial);
      scene.add(stars);


      // Planet Meshes and Orbits
      const planetMeshes = [];
      planetsData.forEach((planet) => {
        const geometry = new THREE.SphereGeometry(planet.radius, 64, 64); // Increased segments
        const material = new THREE.MeshStandardMaterial({
          color: 0xffffff,
          emissive: planet.id === 0 ? 0xffff00 : 0x000000, // Sun ID is 0
          emissiveIntensity: planet.id === 0 ? 1.8 : 0, // Slightly stronger emission
        });
        loader.load(
          `textures/${planet.texture}`,
          (texture) => {
            material.map = texture;
            if (planet.id === 0) {
              material.emissiveMap = texture; // Make sun texture glow
              material.emissive = new THREE.Color(0xffffaa); // Slightly warmer glow
              material.emissiveIntensity = 1.2;
            }
            material.needsUpdate = true;
          },
          undefined,
          (err) => console.error(`Error loading texture: ${planet.texture}`, err)
        );
        const mesh = new THREE.Mesh(geometry, material);
        mesh.position.x = planet.distance;
        mesh.rotation.x = (planet.tilt * Math.PI) / 180;
        mesh.userData.id = planet.id; // Store planet ID in mesh userData
        scene.add(mesh);

        // Create Orbit Paths
        if (planet.distance > 0) {
          const points = [];
          const segments = 128;
          for (let i = 0; i <= segments; i++) {
              const theta = (i / segments) * Math.PI * 2;
              points.push(new THREE.Vector3(Math.cos(theta) * planet.distance, 0, Math.sin(theta) * planet.distance));
          }
          const orbitGeometry = new THREE.BufferGeometry().setFromPoints(points);

          const colorMap = {
              1: 0xaaaaaa, // Mercury
              2: 0xffcc99, // Venus
              3: 0x3399ff, // Earth
              4: 0xff3333, // Mars
              5: 0xffaa33, // Jupiter
              6: 0xffdd77, // Saturn
              7: 0x66ccff, // Uranus
              8: 0x3366cc, // Neptune
          };

          const orbitMaterial = new THREE.LineBasicMaterial({
            color: colorMap[planet.id] || 0xffffff,
            transparent: true,
            opacity: 0.4, // More subtle orbits
          });

          const orbit = new THREE.Line(orbitGeometry, orbitMaterial);
          scene.add(orbit);
        }

         // --- Add Saturn's Rings ---
         if (planet.id === 6) { // Saturn's ID
            const ringTexture = loader.load("textures/saturn_ring.png");
            const innerRadius = planet.radius * 1.2;
            const outerRadius = planet.radius * 2.2;
            const ringGeometry = new THREE.RingGeometry(innerRadius, outerRadius, 64);

            // Correct UV mapping for ring texture
            var pos = ringGeometry.attributes.position;
            var v3 = new THREE.Vector3();
            for (let i = 0; i < pos.count; i++){
                v3.fromBufferAttribute(pos, i);
                ringGeometry.attributes.uv.setXY(i, v3.length() < innerRadius + 0.1 ? 0 : 1, 1);
            }

            const ringMaterial = new THREE.MeshBasicMaterial({ // Use MeshBasicMaterial for rings
                map: ringTexture,
                color: 0xffffff, // Adjust tint if needed
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.8 // Adjust opacity
            });
            const rings = new THREE.Mesh(ringGeometry, ringMaterial);
            rings.rotation.x = Math.PI / 2; // Rotate rings to align horizontally
            mesh.add(rings); // Add rings as child of Saturn mesh
         }

          // Add Jupiter's Great Red Spot (simplified) - Added back
          if (planet.id === 5) { // Jupiter's ID
              const spotGeometry = new THREE.SphereGeometry(planet.radius * 0.2, 16, 16); // Relative size
              const spotMaterial = new THREE.MeshBasicMaterial({ color: 0xbb5533, transparent: true, opacity: 0.8 });
              const redSpot = new THREE.Mesh(spotGeometry, spotMaterial);
              // Position roughly on the surface equatorially
              redSpot.position.set(0, planet.radius * 0.5, planet.radius * 0.85); // Adjust Y and Z
              mesh.add(redSpot); // Add spot as child of Jupiter mesh
          }


        planetMeshes.push({ mesh, planetData: planet, angle: Math.random() * Math.PI * 2 }); // Randomize start angle
      });


      // --- Asteroid Belt ---
      const asteroidGeometry = new THREE.BufferGeometry();
      const asteroidCount = 1500; // More asteroids
      const asteroidPos = new Float32Array(asteroidCount * 3);
      const marsOrbit = planetsData.find(p => p.id === 4).distance;
      const jupiterOrbit = planetsData.find(p => p.id === 5).distance;
      const beltInnerRadius = marsOrbit + 3;
      const beltOuterRadius = jupiterOrbit - 5;
      const beltWidth = beltOuterRadius - beltInnerRadius;

      for (let i = 0; i < asteroidCount; i++) {
        const angle = Math.random() * Math.PI * 2;
        const radius = beltInnerRadius + Math.random() * beltWidth;
        asteroidPos[i * 3] = Math.cos(angle) * radius;
        asteroidPos[i * 3 + 1] = (Math.random() - 0.5) * 1.0; // Slightly wider vertical spread
        asteroidPos[i * 3 + 2] = Math.sin(angle) * radius;
      }
      asteroidGeometry.setAttribute('position', new THREE.BufferAttribute(asteroidPos, 3));
      const asteroidMaterial = new THREE.PointsMaterial({ color: 0xaaaaaa, size: 0.08 }); // Slightly larger
      const asteroids = new THREE.Points(asteroidGeometry, asteroidMaterial);
      scene.add(asteroids);

      // --- Comet --- (Simplified for orbit)
      const cometGeometry = new THREE.SphereGeometry(0.2, 16, 16);
      const cometMaterial = new THREE.MeshBasicMaterial({ color: 0xaaddff });
      const comet = new THREE.Mesh(cometGeometry, cometMaterial);
      scene.add(comet);
      // Simple tail (using a Line)
      const tailPoints = [new THREE.Vector3(0, 0, 0), new THREE.Vector3(0, 0, -2)]; // Tail extends behind
      const tailGeometry = new THREE.BufferGeometry().setFromPoints(tailPoints);
      const tailMaterial = new THREE.LineBasicMaterial({ color: 0xaaddff, transparent: true, opacity: 0.6, linewidth: 2 });
      const tail = new THREE.Line(tailGeometry, tailMaterial);
      comet.add(tail); // Add tail to comet mesh


      // --- Dust Particles --- (Less dense)
      const dustGeometry = new THREE.BufferGeometry();
      const dustCount = 1000;
      const dustPos = new Float32Array(dustCount * 3);
      for (let i = 0; i < dustCount; i++) {
        dustPos[i * 3] = (Math.random() - 0.5) * 200; // Reduced range
        dustPos[i * 3 + 1] = (Math.random() - 0.5) * 200;
        dustPos[i * 3 + 2] = (Math.random() - 0.5) * 200;
      }
      dustGeometry.setAttribute('position', new THREE.BufferAttribute(dustPos, 3));
      const dustMaterial = new THREE.PointsMaterial({
        color: 0x777777, size: 0.05, transparent: true, opacity: 0.4, // More transparent
      });
      const dust = new THREE.Points(dustGeometry, dustMaterial);
      scene.add(dust);

      // --- DOM Elements ---
      const infoPanel = document.getElementById("infoPanel");
      const planetNameEl = document.getElementById("planetName");
      const planetInfoEl = document.getElementById("planetInfo");
      const planetFactEl = document.getElementById("planetFact"); // Fact element
      const closeBtn = document.getElementById("closeBtn");
      const planetsMenu = document.getElementById("planetsMenu");
      const planetsDropdown = document.getElementById("planetsDropdown");
      const langToggleBtn = document.getElementById("langToggleBtn");
      const bodyEl = document.body;

      // --- Raycasting ---
      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2();

      // --- Event Listeners ---
      window.addEventListener("click", (event) => {
        // Prevent clicks on menu/infopanel from triggering raycast
        if (event.target.closest('#menuBar') || event.target.closest('#infoPanel')) {
             return;
        }

        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);

        const intersects = raycaster.intersectObjects(planetMeshes.map((p) => p.mesh));

        if (intersects.length > 0) {
          const clickedPlanetMesh = intersects[0].object;
          const planetId = clickedPlanetMesh.userData.id;
          const planetData = planetsData.find(p => p.id === planetId);

          if (planetData) {
            displayPlanetInfo(planetData); // Use the display function
            isFollowingPlanet = false; // Stop following if clicking manually
            focusedPlanetIndex = -1;
          }
        } else {
            // Optional: Hide info panel if clicking empty space
            // infoPanel.style.display = 'none';
        }
      });

      closeBtn.addEventListener("click", () => {
        infoPanel.style.display = "none";
        isFollowingPlanet = false; // Stop following when closing panel
        focusedPlanetIndex = -1;
      });

      planetsMenu.addEventListener("click", (e) => {
        e.stopPropagation(); // Prevent document click handler
        planetsDropdown.classList.toggle("show");
      });

      // Close dropdown if clicking outside
      document.addEventListener("click", (e) => {
          if (!planetsMenu.contains(e.target)) {
              planetsDropdown.classList.remove('show');
          }
      });

      langToggleBtn.addEventListener("click", () => {
          currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
          updateLanguageUI();
          // If info panel is open, update its content immediately
          if (infoPanel.style.display === 'block' && focusedPlanetIndex !== -1) {
               const currentPlanetData = planetsData[focusedPlanetIndex];
               displayPlanetInfo(currentPlanetData);
          } else if (infoPanel.style.display === 'block') {
              // Find which planet info is displayed if not following (rare case)
               const displayedName = planetNameEl.textContent;
               const currentPlanetData = planetsData.find(p => p.name[currentLanguage === 'ar' ? 'en' : 'ar'] === displayedName); // Check against the *other* lang
               if (currentPlanetData) displayPlanetInfo(currentPlanetData);
          }
      });

      // --- Functions ---

      function displayPlanetInfo(planetData) {
         planetNameEl.textContent = planetData.name[currentLanguage];
         planetInfoEl.innerHTML = planetData.info[currentLanguage].replace(/\n/g, "<br>");
         planetFactEl.textContent = planetData.fact[currentLanguage]; // Display fact
         infoPanel.style.display = "block";
      }


      function updateLanguageUI() {
          // Update body direction
          bodyEl.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';

          // Update menu text
          planetsMenu.firstChild.textContent = uiText.planetsMenu[currentLanguage].trim(); // Update "Planets" text node
          langToggleBtn.textContent = uiText.langToggle[currentLanguage];

          // Update dropdown items
          planetsDropdown.innerHTML = ''; // Clear existing items
          planetsData.forEach((planet) => {
              const item = document.createElement("a");
              item.href = "#";
              item.classList.add("dropdown-item");
              item.setAttribute("data-planet-id", planet.id);
              item.textContent = planet.name[currentLanguage];
              item.addEventListener("click", (e) => {
                  e.preventDefault();
                  e.stopPropagation(); // Prevent closing dropdown immediately
                  const planetId = parseInt(item.getAttribute("data-planet-id"));
                  focusOnPlanet(planetId);
                  planetsDropdown.classList.remove("show");
              });
              planetsDropdown.appendChild(item);
          });

         // Adjust info panel text alignment based on language (already handled by body dir and CSS)
         infoPanel.style.textAlign = currentLanguage === 'ar' ? 'right' : 'left';
      }


      function focusOnPlanet(planetId) {
          const planetIndex = planetsData.findIndex(p => p.id === planetId);
          if (planetIndex === -1) return;

          const targetPlanet = planetMeshes[planetIndex];
          const targetData = targetPlanet.planetData;

          if (followAnimationId) cancelAnimationFrame(followAnimationId); // Cancel previous animation

          focusedPlanetIndex = planetIndex;
          infoPanel.style.display = 'none'; // Hide panel during transition

          const startPosition = camera.position.clone();
          const startTarget = controls.target.clone(); // Track current lookAt target
          const endTarget = targetPlanet.mesh.position.clone(); // Look at the planet center

          // Calculate end position: behind the planet, scaled by radius
          const offsetDistance = targetData.radius * (targetData.id === 0 ? 5 : 8); // Closer for sun, further for planets
          const direction = new THREE.Vector3(0, 0.2, 1); // Slightly above and behind
          direction.applyQuaternion(targetPlanet.mesh.quaternion); // Align with planet's current orientation if needed (though they don't rotate much here)
          direction.normalize();
          const endPosition = endTarget.clone().add(direction.multiplyScalar(offsetDistance));


          const duration = 1500; // ms
          const startTime = Date.now();

          function animateCameraFocus() {
              const elapsed = Date.now() - startTime;
              const progress = Math.min(elapsed / duration, 1);
              const easeProgress = 0.5 * (1 - Math.cos(Math.PI * progress)); // Ease-in-out

              camera.position.lerpVectors(startPosition, endPosition, easeProgress);
              controls.target.lerpVectors(startTarget, endTarget, easeProgress); // Smoothly transition target
              controls.update(); // IMPORTANT: Update controls after changing target

              if (progress < 1) {
                  followAnimationId = requestAnimationFrame(animateCameraFocus);
              } else {
                  followAnimationId = null;
                  isFollowingPlanet = true; // Start following *after* animation
                  controls.target.copy(endTarget); // Ensure target is exact
                  camera.position.copy(endPosition); // Ensure position is exact
                  controls.update();
                  displayPlanetInfo(targetData); // Show info panel *after* arriving
              }
          }

          animateCameraFocus();
      }


      // --- Animation Loop ---
      function animate() {
        requestAnimationFrame(animate);
        const delta = Date.now() * 0.0001; // Time factor for consistent speed

        planetMeshes.forEach((p, index) => {
          const { mesh, planetData } = p;
          // Planet Rotation
          mesh.rotation.y += planetData.rotation * 0.1; // Slow down rotation for visuals

          // Planet Orbit
          if (planetData.distance > 0) {
            p.angle += planetData.speed * 0.5; // Slow down orbit speed
            mesh.position.x = Math.cos(p.angle) * planetData.distance;
            mesh.position.z = Math.sin(p.angle) * planetData.distance;
          }

            // Make Jupiter's Red Spot rotate with Jupiter
            if (planetData.id === 5) { // Jupiter
                const spot = mesh.children.find(child => child.geometry.type === 'SphereGeometry'); // Find the spot
                if (spot) {
                    // Rotate spot around Jupiter's Y axis (relative to Jupiter)
                    // This requires keeping track of its own angle or using complex rotations.
                    // Simple approach: just let it be visually attached, rotation applied to parent.
                }
            }
            // Make Saturn's rings rotate with Saturn
            if (planetData.id === 6) { // Saturn
                const rings = mesh.children.find(child => child.geometry.type === 'RingGeometry');
                if (rings) {
                   // Rings naturally rotate with the parent mesh (Saturn)
                }
            }


          // Camera Following Logic
          if (isFollowingPlanet && index === focusedPlanetIndex) {
            const currentTargetPosition = mesh.position.clone();
            controls.target.copy(currentTargetPosition); // Keep controls target updated

             // Calculate desired camera position relative to the moving planet
            const offsetDistance = planetData.radius * (planetData.id === 0 ? 5 : 8);
            const direction = new THREE.Vector3(0, 0.2, 1); // Slightly above and behind
            direction.applyQuaternion(mesh.quaternion); // Use planet's current orientation
            direction.normalize();
            const desiredPosition = currentTargetPosition.clone().add(direction.multiplyScalar(offsetDistance));

            // Smoothly move camera to the desired position relative to the planet
            camera.position.lerp(desiredPosition, 0.05); // Adjust lerp factor for smoothness
          }
        });

         // Comet Animation (Elliptical-like Path)
         const cometTime = Date.now() * 0.0002;
         const cometSemiMajor = 80;
         const cometSemiMinor = 50;
         comet.position.x = Math.cos(cometTime) * cometSemiMajor;
         comet.position.z = Math.sin(cometTime) * cometSemiMinor;
         comet.position.y = Math.sin(cometTime * 0.7) * 15; // Add some vertical movement
         // Orient tail away from the sun (approximate)
         const dirToSun = comet.position.clone().normalize().negate();
         comet.lookAt(comet.position.clone().add(dirToSun)); // Make comet head look away from sun


        controls.update(); // Update controls even when following for damping/inertia
        renderer.render(scene, camera);
      }

      // --- Initial Setup ---
      updateLanguageUI(); // Set initial language and populate dropdown
      animate();

      // --- Resize Listener ---
      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    </script>
  </body>
</html>
