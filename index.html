<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FalakZoom</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: black;
        font-family: "Poppins", "Cairo", Arial, sans-serif;
      }

      #infoPanel {
        position: absolute;
        top: 70px;
        left: 20px;
        background: rgba(0, 0, 0, 0.88);
        color: white;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.4);
        display: none;
        max-width: 400px;
        max-height: calc(100vh - 90px);
        overflow-y: auto;
        font-size: 14px;
        line-height: 1.7;
        z-index: 50;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.3) rgba(0, 0, 0, 0.5);
      }
       #infoPanel::-webkit-scrollbar { width: 8px; }
       #infoPanel::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.5); border-radius: 10px; }
       #infoPanel::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.3); border-radius: 10px; border: 2px solid rgba(0, 0, 0, 0.5); }

      #infoPanel h2 { margin-top: 0; margin-bottom: 15px; font-size: 18px; font-weight: 600; border-bottom: 1px solid rgba(255, 255, 255, 0.3); padding-bottom: 8px; }
      #infoPanel p { margin-bottom: 10px; }
      #infoPanel .fact { font-style: italic; color: #cccccc; margin-top: 15px; padding-top: 10px; border-top: 1px dashed rgba(255, 255, 255, 0.2); }

      #readMoreBtn { background-color: rgba(255, 255, 255, 0.15); color: #e0e0e0; border: 1px solid rgba(255, 255, 255, 0.3); padding: 8px 15px; border-radius: 5px; cursor: pointer; font-family: inherit; font-size: 13px; margin-top: 15px; transition: background-color 0.3s, color 0.3s; display: block; width: fit-content; }
      #readMoreBtn:hover { background-color: rgba(255, 255, 255, 0.25); color: white; }

      #extraFactsContainer { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.3); }
      #extraFactsContainer p { font-size: 13px; color: #bbbbbb; margin-bottom: 8px; padding-left: 10px; position: relative; }
      #extraFactsContainer p::before { content: '•'; position: absolute; left: -2px; top: 0; color: #66ccff; }
      [dir="rtl"] #extraFactsContainer p { padding-left: 0; padding-right: 10px; }
      [dir="rtl"] #extraFactsContainer p::before { left: auto; right: -2px; }

      #closeBtn { position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; font-size: 16px; font-weight: bold; color: #ff6b6b; cursor: pointer; transition: transform 0.3s ease, color 0.3s ease, background 0.3s ease; padding: 0; background: rgba(255, 255, 255, 0.1); border: none; border-radius: 50%; display: flex; justify-content: center; align-items: center; z-index: 51; }
      #closeBtn:hover { color: #ff4757; transform: scale(1.1) rotate(90deg); background: rgba(255, 255, 255, 0.2); }

      #menuBar { position: absolute; top: 0; left: 0; width: 100%; height: 50px; background: rgba(0, 0, 0, 0.85); padding: 0 20px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; z-index: 100; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }

      /* Updated menu controls container */
      .menu-controls { display: flex; align-items: center; gap: 15px; /* Add gap between control groups */ }

      .menu-item, #langToggleBtn { position: relative; color: white; padding: 8px 15px; cursor: pointer; font-family: "Poppins", "Cairo", sans-serif; border-radius: 4px; transition: background 0.3s ease, color 0.3s ease; font-size: 14px; user-select: none; background: none; border: none; }
      .menu-item:hover, #langToggleBtn:hover { background: rgba(255, 255, 255, 0.2); color: #eee; }

      /* Group planets menu and lang toggle */
      .menu-group { display: flex; align-items: center; gap: 5px;}

      .dropdown { position: absolute; top: 100%; right: 0; background: rgba(25, 25, 25, 0.95); min-width: 180px; border-radius: 0 0 6px 6px; overflow: hidden; display: none; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-top: none; z-index: 110; }
      .dropdown.show { display: block; }
      .dropdown-item { padding: 12px 20px; color: #e0e0e0; text-decoration: none; display: block; transition: background 0.2s ease, color 0.2s ease; font-size: 14px; white-space: nowrap; }
      .dropdown-item:hover { background: rgba(255, 255, 255, 0.15); color: white; }

      #title { color: white; font-family: "Poppins", sans-serif; font-size: 22px; font-weight: 600; margin-right: auto; /* Pushes other controls right */ }

       /* Speed Slider Styles */
       #speedControlContainer { display: flex; align-items: center; color: white; font-size: 13px; margin-left: auto; /* Push speed control to the right */ padding-right: 20px; /* Add some spacing */ }
       #speedControlContainer label { margin-right: 8px; font-weight: 400; }
       #speedSlider { width: 120px; /* Adjust width as needed */ height: 5px; cursor: pointer; background: rgba(255, 255, 255, 0.3); border-radius: 5px; appearance: none; -webkit-appearance: none; }
       /* Thumb Styles (Webkit - Chrome, Safari, Edge) */
       #speedSlider::-webkit-slider-thumb { appearance: none; -webkit-appearance: none; width: 14px; height: 14px; background: #aaddff; border-radius: 50%; cursor: pointer; border: 1px solid #555; }
        /* Thumb Styles (Firefox) */
       #speedSlider::-moz-range-thumb { width: 14px; height: 14px; background: #aaddff; border-radius: 50%; cursor: pointer; border: 1px solid #555; }
       #speedValueDisplay { margin-left: 10px; min-width: 35px; /* Reserve space */ text-align: right; font-weight: 600; color: #aaddff; }
       /* Optional labels for slider context */
       .speed-label { font-size: 11px; color: #aaa; margin: 0 5px; }


       /* Language Direction Adjustments */
       body[dir="rtl"] #infoPanel { left: auto; right: 20px; text-align: right; }
       body[dir="ltr"] #infoPanel { left: 20px; right: auto; text-align: left; }
       body[dir="rtl"] #closeBtn { left: 10px; right: auto; }
       body[dir="ltr"] #closeBtn { left: auto; right: 10px; }
       body[dir="rtl"] #readMoreBtn { margin-right: auto; }
       body[dir="ltr"] #readMoreBtn { margin-left: auto; }
       /* Adjust menu layout for RTL if needed */
       body[dir="rtl"] .menu-group { margin-right: auto; margin-left: 0; }
       body[dir="ltr"] .menu-group { margin-left: auto; margin-right: 0; }
       body[dir="rtl"] #speedControlContainer { margin-right: auto; margin-left: 0; padding-left: 20px; padding-right: 0; }
       body[dir="ltr"] #speedControlContainer { margin-left: auto; margin-right: 0; padding-right: 20px; padding-left: 0; }


    </style>
  </head>
  <body dir="rtl"> <div id="menuBar">
      <div id="title">FalakZoom</div>

      <div id="speedControlContainer">
          <label for="speedSlider">Speed:</label>
          <input type="range" id="speedSlider" min="0.1" max="20" step="0.1" value="1">
          <span id="speedValueDisplay">1.0x</span>
      </div>

      <div class="menu-group">
        <button id="langToggleBtn">English</button> <div class="menu-item" id="planetsMenu">
          الكواكب
          <div class="dropdown" id="planetsDropdown">
            </div>
        </div>
      </div>
    </div>

    <div id="infoPanel">
      <span id="closeBtn">X</span>
      <h2 id="planetName"></h2>
      <p id="planetInfo"></p>
      <p id="planetFact" class="fact"></p>
      <button id="readMoreBtn"></button>
      <div id="extraFactsContainer" style="display: none;">
          </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/controls/OrbitControls.js"></script>
    <script>
      // --- Global Settings & State ---
      let currentLanguage = 'ar';
      let currentlyDisplayedPlanetId = null;
      let simulationSpeedMultiplier = 1.0; // Initial speed multiplier

      const uiText = {
          planetsMenu: { ar: "الكواكب", en: "Planets" },
          langToggle: { ar: "English", en: "العربية" },
          readMore: { ar: "اقرأ المزيد", en: "Read More" },
      };

      // --- Planet Data (Shortened for Brevity - Assume full data is here) ---
      const planetsData = [
        { id: 0, name: { ar: "الشمس", en: "Sun" }, radius: 5, distance: 0, speed: 0, tilt: 0, rotation: 0.01, texture: "sun.jpg", info: { ar: "...", en: "..." }, fact: { ar: "...", en: "..." }, extraFacts: [{ ar: "...", en: "..." }, { ar: "...", en: "..." }, { ar: "...", en: "..." }] },
        { id: 1, name: { ar: "عطارد", en: "Mercury" }, radius: 0.5, distance: 10, speed: 0.0125, tilt: 0.034, rotation: 0.003, texture: "mercury.jpg", info: { ar: "...", en: "..." }, fact: { ar: "...", en: "..." }, extraFacts: [{ ar: "...", en: "..." }, { ar: "...", en: "..." }, { ar: "...", en: "..." }] },
        { id: 2, name: { ar: "الزهرة", en: "Venus" }, radius: 0.8, distance: 15, speed: 0.004375, tilt: 177.4, rotation: 0.0004, texture: "venus.jpg", info: { ar: "...", en: "..." }, fact: { ar: "...", en: "..." }, extraFacts: [{ ar: "...", en: "..." }, { ar: "...", en: "..." }, { ar: "...", en: "..." }] },
        { id: 3, name: { ar: "الأرض", en: "Earth" }, radius: 1, distance: 20, speed: 0.003125, tilt: 23.5, rotation: 0.05, texture: "earth.jpg", info: { ar: "...", en: "..." }, fact: { ar: "...", en: "..." }, extraFacts: [{ ar: "...", en: "..." }, { ar: "...", en: "..." }, { ar: "...", en: "..." }] },
        { id: 4, name: { ar: "المريخ", en: "Mars" }, radius: 0.7, distance: 25, speed: 0.0025, tilt: 25.2, rotation: 0.048, texture: "mars.jpg", info: { ar: "...", en: "..." }, fact: { ar: "...", en: "..." }, extraFacts: [{ ar: "...", en: "..." }, { ar: "...", en: "..." }, { ar: "...", en: "..." }] },
        { id: 5, name: { ar: "المشتري", en: "Jupiter" }, radius: 2.5, distance: 35, speed: 0.00125, tilt: 3.1, rotation: 0.1, texture: "jupiter.jpg", info: { ar: "...", en: "..." }, fact: { ar: "...", en: "..." }, extraFacts: [{ ar: "...", en: "..." }, { ar: "...", en: "..." }, { ar: "...", en: "..." }] },
        { id: 6, name: { ar: "زحل", en: "Saturn" }, radius: 2, distance: 45, speed: 0.0009375, tilt: 26.7, rotation: 0.09, texture: "saturn.jpg", info: { ar: "...", en: "..." }, fact: { ar: "...", en: "..." }, extraFacts: [{ ar: "...", en: "..." }, { ar: "...", en: "..." }, { ar: "...", en: "..." }] },
        { id: 7, name: { ar: "أورانوس", en: "Uranus" }, radius: 1.5, distance: 55, speed: 0.0005, tilt: 97.8, rotation: 0.06, texture: "uranus.jpg", info: { ar: "...", en: "..." }, fact: { ar: "...", en: "..." }, extraFacts: [{ ar: "...", en: "..." }, { ar: "...", en: "..." }, { ar: "...", en: "..." }] },
        { id: 8, name: { ar: "نبتون", en: "Neptune" }, radius: 1.5, distance: 65, speed: 0.000375, tilt: 28.3, rotation: 0.07, texture: "neptune.jpg", info: { ar: "...", en: "..." }, fact: { ar: "...", en: "..." }, extraFacts: [{ ar: "...", en: "..." }, { ar: "...", en: "..." }, { ar: "...", en: "..." }] }
      ]; // NOTE: Ensure you have the full planet data objects here from previous steps


      // --- THREE.js Setup (Unchanged logic) ---
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75,window.innerWidth / window.innerHeight, 0.1, 2000);
      camera.position.set(0, 50, 100);
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.maxDistance = 400; controls.minDistance = 10;
      controls.enableDamping = true; controls.dampingFactor = 0.05;
      let focusedPlanetIndex = -1; let isFollowingPlanet = false; let followAnimationId = null;
      controls.addEventListener("start", () => { isFollowingPlanet = false; focusedPlanetIndex = -1; if (followAnimationId) cancelAnimationFrame(followAnimationId); });
      const sunLight = new THREE.PointLight(0xffffff, 1.5, 1500); scene.add(sunLight);
      const ambientLight = new THREE.AmbientLight(0x404040, 0.6); scene.add(ambientLight);
      const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.3); hemiLight.position.set(0, 100, 0); scene.add(hemiLight);
      const loader = new THREE.TextureLoader();
      const starGeometry = new THREE.BufferGeometry(); const starCount = 7000; const positions = new Float32Array(starCount * 3); for (let i = 0; i < starCount; i++) { positions[i * 3] = (Math.random() - 0.5) * 2500; positions[i * 3 + 1] = (Math.random() - 0.5) * 2500; positions[i * 3 + 2] = (Math.random() - 0.5) * 2500;} starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3)); const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.15 }); const stars = new THREE.Points(starGeometry, starMaterial); scene.add(stars);
      const planetMeshes = [];
      planetsData.forEach((planet) => {
        const geometry = new THREE.SphereGeometry(planet.radius, 64, 64); const material = new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: planet.id === 0 ? 0xffff00 : 0x000000, emissiveIntensity: planet.id === 0 ? 1.8 : 0, }); loader.load(`textures/${planet.texture}`, (texture) => { material.map = texture; if (planet.id === 0) { material.emissiveMap = texture; material.emissive = new THREE.Color(0xffffaa); material.emissiveIntensity = 1.2;} material.needsUpdate = true; }, undefined, (err) => console.error(`Error loading texture: ${planet.texture}`, err)); const mesh = new THREE.Mesh(geometry, material); mesh.position.x = planet.distance; mesh.rotation.x = (planet.tilt * Math.PI) / 180; mesh.userData.id = planet.id; scene.add(mesh);
        if (planet.distance > 0) { const points = []; const segments = 128; for (let i = 0; i <= segments; i++) { const theta = (i / segments) * Math.PI * 2; points.push(new THREE.Vector3(Math.cos(theta) * planet.distance, 0, Math.sin(theta) * planet.distance));} const orbitGeometry = new THREE.BufferGeometry().setFromPoints(points); const colorMap = { 1: 0xaaaaaa, 2: 0xffcc99, 3: 0x3399ff, 4: 0xff3333, 5: 0xffaa33, 6: 0xffdd77, 7: 0x66ccff, 8: 0x3366cc, }; const orbitMaterial = new THREE.LineBasicMaterial({ color: colorMap[planet.id] || 0xffffff, transparent: true, opacity: 0.4, }); const orbit = new THREE.Line(orbitGeometry, orbitMaterial); scene.add(orbit);}
        if (planet.id === 6) { const ringTexture = loader.load("textures/saturn_ring.png"); const innerRadius = planet.radius * 1.2; const outerRadius = planet.radius * 2.2; const ringGeometry = new THREE.RingGeometry(innerRadius, outerRadius, 64); var pos = ringGeometry.attributes.position; var v3 = new THREE.Vector3(); for (let i = 0; i < pos.count; i++){ v3.fromBufferAttribute(pos, i); ringGeometry.attributes.uv.setXY(i, v3.length() < innerRadius + 0.1 ? 0 : 1, 1); } const ringMaterial = new THREE.MeshBasicMaterial({ map: ringTexture, color: 0xffffff, side: THREE.DoubleSide, transparent: true, opacity: 0.8 }); const rings = new THREE.Mesh(ringGeometry, ringMaterial); rings.rotation.x = Math.PI / 2; mesh.add(rings); }
        if (planet.id === 5) { const spotGeometry = new THREE.SphereGeometry(planet.radius * 0.2, 16, 16); const spotMaterial = new THREE.MeshBasicMaterial({ color: 0xbb5533, transparent: true, opacity: 0.8 }); const redSpot = new THREE.Mesh(spotGeometry, spotMaterial); redSpot.position.set(0, planet.radius * 0.5, planet.radius * 0.85); mesh.add(redSpot); }
        planetMeshes.push({ mesh, planetData: planet, angle: Math.random() * Math.PI * 2 });
      });
      const asteroidGeometry = new THREE.BufferGeometry(); const asteroidCount = 1500; const asteroidPos = new Float32Array(asteroidCount * 3); const marsOrbit = planetsData.find(p => p.id === 4).distance; const jupiterOrbit = planetsData.find(p => p.id === 5).distance; const beltInnerRadius = marsOrbit + 3; const beltOuterRadius = jupiterOrbit - 5; const beltWidth = beltOuterRadius - beltInnerRadius; for (let i = 0; i < asteroidCount; i++) { const angle = Math.random() * Math.PI * 2; const radius = beltInnerRadius + Math.random() * beltWidth; asteroidPos[i * 3] = Math.cos(angle) * radius; asteroidPos[i * 3 + 1] = (Math.random() - 0.5) * 1.0; asteroidPos[i * 3 + 2] = Math.sin(angle) * radius; } asteroidGeometry.setAttribute('position', new THREE.BufferAttribute(asteroidPos, 3)); const asteroidMaterial = new THREE.PointsMaterial({ color: 0xaaaaaa, size: 0.08 }); const asteroids = new THREE.Points(asteroidGeometry, asteroidMaterial); scene.add(asteroids);
      const cometGeometry = new THREE.SphereGeometry(0.2, 16, 16); const cometMaterial = new THREE.MeshBasicMaterial({ color: 0xaaddff }); const comet = new THREE.Mesh(cometGeometry, cometMaterial); scene.add(comet); const tailPoints = [new THREE.Vector3(0, 0, 0), new THREE.Vector3(0, 0, -2)]; const tailGeometry = new THREE.BufferGeometry().setFromPoints(tailPoints); const tailMaterial = new THREE.LineBasicMaterial({ color: 0xaaddff, transparent: true, opacity: 0.6, linewidth: 2 }); const tail = new THREE.Line(tailGeometry, tailMaterial); comet.add(tail);
      const dustGeometry = new THREE.BufferGeometry(); const dustCount = 1000; const dustPos = new Float32Array(dustCount * 3); for (let i = 0; i < dustCount; i++) { dustPos[i * 3] = (Math.random() - 0.5) * 200; dustPos[i * 3 + 1] = (Math.random() - 0.5) * 200; dustPos[i * 3 + 2] = (Math.random() - 0.5) * 200; } dustGeometry.setAttribute('position', new THREE.BufferAttribute(dustPos, 3)); const dustMaterial = new THREE.PointsMaterial({ color: 0x777777, size: 0.05, transparent: true, opacity: 0.4, }); const dust = new THREE.Points(dustGeometry, dustMaterial); scene.add(dust);

      // --- DOM Elements ---
      const infoPanel = document.getElementById("infoPanel");
      const planetNameEl = document.getElementById("planetName");
      const planetInfoEl = document.getElementById("planetInfo");
      const planetFactEl = document.getElementById("planetFact");
      const closeBtn = document.getElementById("closeBtn");
      const planetsMenu = document.getElementById("planetsMenu");
      const planetsDropdown = document.getElementById("planetsDropdown");
      const langToggleBtn = document.getElementById("langToggleBtn");
      const bodyEl = document.body;
      const readMoreBtn = document.getElementById("readMoreBtn");
      const extraFactsContainer = document.getElementById("extraFactsContainer");
      const speedSlider = document.getElementById("speedSlider"); // Speed Slider Element
      const speedValueDisplay = document.getElementById("speedValueDisplay"); // Speed Value Display Element

      // --- Raycasting ---
      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2();

      // --- Event Listeners ---
      window.addEventListener("click", (event) => {
        if (event.target.closest('#menuBar') || event.target.closest('#infoPanel')) return;
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(planetMeshes.map((p) => p.mesh));
        if (intersects.length > 0) {
          const clickedPlanetMesh = intersects[0].object;
          const planetId = clickedPlanetMesh.userData.id;
          if (planetId !== undefined) focusOnPlanet(planetId); // Trigger focus on click
        }
      });

      closeBtn.addEventListener("click", () => {
        infoPanel.style.display = "none";
        isFollowingPlanet = false; focusedPlanetIndex = -1;
        currentlyDisplayedPlanetId = null;
      });

      planetsMenu.addEventListener("click", (e) => {
        e.stopPropagation(); planetsDropdown.classList.toggle("show");
      });

      document.addEventListener("click", (e) => {
          if (!planetsMenu.contains(e.target) && !planetsDropdown.contains(e.target)) { // Ensure dropdown itself doesn't close it
               planetsDropdown.classList.remove('show');
          }
      });

      langToggleBtn.addEventListener("click", () => {
          currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
          updateLanguageUI();
      });

       readMoreBtn.addEventListener("click", () => {
           const planetId = parseInt(readMoreBtn.getAttribute('data-planet-id'));
           if (isNaN(planetId)) return;
           const planetData = planetsData.find(p => p.id === planetId);
           if (planetData && planetData.extraFacts) {
               populateExtraFacts(planetData.extraFacts);
               extraFactsContainer.style.display = 'block';
               readMoreBtn.style.display = 'none';
           }
       });

       // Speed Slider Listener
       speedSlider.addEventListener('input', (event) => {
           simulationSpeedMultiplier = parseFloat(event.target.value);
           speedValueDisplay.textContent = simulationSpeedMultiplier.toFixed(1) + 'x';
       });

      // --- Functions ---

       function populateExtraFacts(facts) {
            extraFactsContainer.innerHTML = '';
            facts.forEach(fact => { const p = document.createElement('p'); p.textContent = fact[currentLanguage]; extraFactsContainer.appendChild(p); });
       }

      function displayPlanetInfo(planetData) {
         planetNameEl.textContent = planetData.name[currentLanguage];
         planetInfoEl.innerHTML = planetData.info[currentLanguage].replace(/\n/g, "<br>");
         planetFactEl.textContent = planetData.fact[currentLanguage];
         currentlyDisplayedPlanetId = planetData.id;
         extraFactsContainer.style.display = 'none'; extraFactsContainer.innerHTML = '';
         if (planetData.extraFacts && planetData.extraFacts.length > 0) { readMoreBtn.style.display = 'block'; readMoreBtn.setAttribute('data-planet-id', planetData.id); readMoreBtn.textContent = uiText.readMore[currentLanguage]; } else { readMoreBtn.style.display = 'none'; }
         infoPanel.style.display = "block"; infoPanel.scrollTop = 0;
      }


      function updateLanguageUI() {
          bodyEl.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
          // Safely update text content of menu item (avoiding replacing dropdown div)
          const planetsMenuTextNode = Array.from(planetsMenu.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
          if(planetsMenuTextNode) planetsMenuTextNode.textContent = uiText.planetsMenu[currentLanguage].trim() + ' '; // Add space before dropdown caret might appear

          langToggleBtn.textContent = uiText.langToggle[currentLanguage];
          readMoreBtn.textContent = uiText.readMore[currentLanguage];

          planetsDropdown.innerHTML = '';
          planetsData.forEach((planet) => {
              const item = document.createElement("a"); item.href = "#"; item.classList.add("dropdown-item"); item.setAttribute("data-planet-id", planet.id); item.textContent = planet.name[currentLanguage];
              item.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); const planetId = parseInt(item.getAttribute("data-planet-id")); focusOnPlanet(planetId); planetsDropdown.classList.remove("show"); });
              planetsDropdown.appendChild(item);
          });

           if (currentlyDisplayedPlanetId !== null) {
               const currentPlanetData = planetsData.find(p => p.id === currentlyDisplayedPlanetId);
               if (currentPlanetData) {
                   planetNameEl.textContent = currentPlanetData.name[currentLanguage];
                   planetInfoEl.innerHTML = currentPlanetData.info[currentLanguage].replace(/\n/g, "<br>");
                   planetFactEl.textContent = currentPlanetData.fact[currentLanguage];
                   readMoreBtn.setAttribute('data-planet-id', currentPlanetData.id);
                   if (extraFactsContainer.style.display === 'block' && currentPlanetData.extraFacts) populateExtraFacts(currentPlanetData.extraFacts);
                   if (extraFactsContainer.style.display !== 'block' && currentPlanetData.extraFacts && currentPlanetData.extraFacts.length > 0) readMoreBtn.style.display = 'block'; else readMoreBtn.style.display = 'none';
               }
           }
         infoPanel.style.textAlign = currentLanguage === 'ar' ? 'right' : 'left';
      }


      function focusOnPlanet(planetId) {
          const planetIndex = planetsData.findIndex(p => p.id === planetId);
          if (planetIndex === -1) return;
          const targetPlanet = planetMeshes[planetIndex]; const targetData = targetPlanet.planetData;
          if (followAnimationId) cancelAnimationFrame(followAnimationId);
          focusedPlanetIndex = planetIndex; infoPanel.style.display = 'none'; currentlyDisplayedPlanetId = null;
          const startPosition = camera.position.clone(); const startTarget = controls.target.clone();
          const endTarget = targetPlanet.mesh.position.clone();
          const offsetDistance = targetData.radius * (targetData.id === 0 ? 5 : 8);
          const direction = new THREE.Vector3(0, 0.2, 1); direction.applyQuaternion(targetPlanet.mesh.quaternion); direction.normalize();
          const endPosition = endTarget.clone().add(direction.multiplyScalar(offsetDistance));
          const duration = 1500; const startTime = Date.now();
          function animateCameraFocus() {
              const elapsed = Date.now() - startTime; const progress = Math.min(elapsed / duration, 1);
              const easeProgress = 0.5 * (1 - Math.cos(Math.PI * progress));
              camera.position.lerpVectors(startPosition, endPosition, easeProgress);
              controls.target.lerpVectors(startTarget, endTarget, easeProgress); controls.update();
              if (progress < 1) { followAnimationId = requestAnimationFrame(animateCameraFocus); }
              else { followAnimationId = null; isFollowingPlanet = true; controls.target.copy(endTarget); camera.position.copy(endPosition); controls.update(); displayPlanetInfo(targetData); }
          }
          animateCameraFocus();
      }


      // --- Animation Loop ---
      function animate() {
        requestAnimationFrame(animate);
        // Use the speed multiplier here
        const speedAdjust = simulationSpeedMultiplier;

        planetMeshes.forEach((p, index) => {
          const { mesh, planetData } = p;
          // Apply speed multiplier to rotation
          mesh.rotation.y += planetData.rotation * 0.1 * speedAdjust;

          // Apply speed multiplier to orbit
          if (planetData.distance > 0) {
            p.angle += planetData.speed * 0.5 * speedAdjust; // Adjust orbit speed
            mesh.position.x = Math.cos(p.angle) * planetData.distance;
            mesh.position.z = Math.sin(p.angle) * planetData.distance;
          }

          if (isFollowingPlanet && index === focusedPlanetIndex) {
            const currentTargetPosition = mesh.position.clone();
            controls.target.copy(currentTargetPosition);
            const offsetDistance = planetData.radius * (planetData.id === 0 ? 5 : 8);
            const direction = new THREE.Vector3(0, 0.2, 1);
            direction.applyQuaternion(mesh.quaternion);
            direction.normalize();
            const desiredPosition = currentTargetPosition.clone().add(direction.multiplyScalar(offsetDistance));
            camera.position.lerp(desiredPosition, 0.05);
          }
        });

         // Apply speed multiplier to comet
         const cometTime = Date.now() * 0.0002 * speedAdjust; // Adjust comet speed
         const cometSemiMajor = 80; const cometSemiMinor = 50;
         comet.position.x = Math.cos(cometTime) * cometSemiMajor;
         comet.position.z = Math.sin(cometTime) * cometSemiMinor;
         comet.position.y = Math.sin(cometTime * 0.7) * 15;
         const dirToSun = comet.position.clone().normalize().negate();
         comet.lookAt(comet.position.clone().add(dirToSun));

        controls.update();
        renderer.render(scene, camera);
      }

      // --- Initial Setup ---
      // Set initial slider display value
      speedValueDisplay.textContent = simulationSpeedMultiplier.toFixed(1) + 'x';
      updateLanguageUI();
      animate();

      // --- Resize Listener ---
      window.addEventListener("resize", () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
       });
    </script>
  </body>
</html>
